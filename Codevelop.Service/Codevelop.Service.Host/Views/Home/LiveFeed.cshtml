
@{
    ViewBag.Title = "Live Feed";
}

<h2>Live Feed</h2>

<div ng-app="app" ng-controller="liveFeedController">
    <div>{{connectionState}}</div>

    <l3>Messages</l3>
    <ul ng-repeat="message in messages">
        <li>{{message}}</li>
    </ul>
</div>

@section scripts
{
<script src="~/Scripts/jquery.signalR-2.2.0.js"></script>
@*<script src="~/SignalR/Hubs"></script>*@

<script>
    angular.module('app', ['SignalR'])
    .controller('liveFeedController', ['$scope', 'Hub', function ($scope, Hub) {
        
        $scope.messages = [];
        $scope.connectionState = "Disconnected";

        //declaring the hub connection 
        var hub = new Hub('DeviceFeedHub', {

            //client side methods 
            listeners: {
                'hello': function (message) {
                    $scope.messages.unshift('Hello received with: ' + message );
                    $scope.$apply();
                }
            },

            //server side methods 
            methods: ['lock', 'unlock'],

            //query params sent on initial connection 
            queryParams: {
                'token': 'exampletoken'
            },

            //handle connection error 
            errorHandler: function (error) {
                console.error(error);
            },

            //specify a non default root 
            rootPath: '../signalR',

            stateChanged: function (state) {
                switch (state.newState) {
                    case $.signalR.connectionState.connecting:
                        $scope.connectionState = "Connecting";
                        break;
                    case $.signalR.connectionState.connected:
                        $scope.connectionState = "Connected";
                        break;
                    case $.signalR.connectionState.reconnecting:
                        $scope.connectionState = "Reconnecting";
                        break;
                    case $.signalR.connectionState.disconnected:
                        $scope.connectionState = "Disconnected";
                        break;
                }
                $scope.$apply();
            }
        });



    }])

</script>
    }